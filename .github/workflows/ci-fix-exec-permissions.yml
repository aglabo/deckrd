# src: ./.github/workflows/ci-auto-chmod-scripts.yml
# @(#) : Auto-fix shell script permissions on push
#
# Copyright (c) 2025 atsushifx <https://github.com/atsushifx>
#
# This software is released under the MIT License.
# https://opensource.org/licenses/MIT

name: Fix executable permissions

# Run on push to non-main branches to auto-fix permissions
permissions:
  contents: write

on:
  push:
    branches-ignore:
      - main
      - master
      - releases
    paths:
      - "**/*.sh"

  workflow_dispatch:

jobs:
  auto-chmod:
    name: Auto-fix shell script permissions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # cspell:words dorny
      - name: Get changed shell scripts
        id: changed-files
        uses: dorny/paths-filter@v3
        with:
          list-files: shell
          filters: |
            scripts:
              - '**/*.sh'

      - name: Check and fix shell script permissions
        id: chmod
        if: steps.changed-files.outputs.scripts == 'true'
        run: |
          sh_files="${{ steps.changed-files.outputs.scripts_files }}"

          echo "Changed shell scripts to check:"
          echo "$sh_files" | tr ' ' '\n'

          changed=false
          changed_files=""
          changed_count=0

          # Check each file's permissions in git index
          for file in $sh_files; do
            # Get file mode from git index (format: 100644 or 100755)
            mode=$(git ls-files -s "$file" | awk '{print $1}')

            if [ "$mode" = "100644" ]; then
              echo "Setting +x on $file (was $mode)"
              git update-index --chmod=+x "$file"

              # Accumulate changed files (newline-separated)
              if [ -z "$changed_files" ]; then
                changed_files="$file"
              else
                changed_files="${changed_files}"$'\n'"${file}"
              fi

              changed_count=$((changed_count + 1))
              changed=true
            elif [ "$mode" = "100755" ]; then
              echo "âœ“ $file already executable"
            fi
          done

          # Output results
          echo "changed=$changed" >> $GITHUB_OUTPUT

          if [ "$changed" = "true" ]; then
            {
              echo "changed_files<<EOF"
              echo "$changed_files"
              echo "EOF"
            } >> $GITHUB_OUTPUT
            echo "changed_count=$changed_count" >> $GITHUB_OUTPUT
            echo "âœ“ Fixed permissions on $changed_count shell script(s)"
          else
            echo "âœ“ All changed shell scripts already have correct permissions"
          fi

      - name: Create PR branch
        id: create_branch
        if: steps.chmod.outputs.changed == 'true'
        run: |
          # Define PR branch name based on source branch
          SOURCE_BRANCH="${{ github.ref_name }}"
          PR_BRANCH="auto-chmod/${SOURCE_BRANCH}"

          echo "Source branch: $SOURCE_BRANCH"
          echo "PR branch: $PR_BRANCH"
          echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT

          # Check if PR branch already exists remotely
          if git ls-remote --heads origin "$PR_BRANCH" | grep -q "$PR_BRANCH"; then
            echo "PR branch already exists, will update it"
            git fetch origin "$PR_BRANCH"
            git checkout -B "$PR_BRANCH" "origin/$PR_BRANCH"
          else
            echo "Creating new PR branch"
            git checkout -b "$PR_BRANCH"
          fi

      - name: Commit permission fixes
        id: commit
        if: steps.chmod.outputs.changed == 'true'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          file_count="${{ steps.chmod.outputs.changed_count }}"

          git commit -m "[Bot] ci(scripts): auto-fix permissions on changed shell scripts

          Automatically set executable permissions on shell scripts modified in ${{ github.ref_name }}.

          Changed files: ${file_count} script(s)

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

      - name: Push PR branch
        id: push
        if: steps.chmod.outputs.changed == 'true'
        run: |
          PR_BRANCH="auto-chmod/${{ github.ref_name }}"

          # Force push to update existing branch if it exists
          git push -f origin "$PR_BRANCH"

          echo "âœ“ Pushed to $PR_BRANCH"

      - name: Create or update Pull Request
        id: create_pr
        if: steps.chmod.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SOURCE_BRANCH="${{ github.ref_name }}"
          PR_BRANCH="auto-chmod/${SOURCE_BRANCH}"

          sh_files="${{ steps.chmod.outputs.changed_files }}"

          # Check if PR already exists from PR branch to source branch
          EXISTING_PR=$(gh pr list --head "$PR_BRANCH" --base "$SOURCE_BRANCH" --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists and has been updated with force push"
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            echo "Creating new Pull Request"

            PR_URL=$(gh pr create \
              --base "$SOURCE_BRANCH" \
              --head "$PR_BRANCH" \
              --title "[Chmod] ci(scripts): Fix shell script permissions" \
              --body "## Auto-generated PR: Shell Script Permission Fix

          This PR automatically fixes executable permissions on shell scripts that were modified in \`$SOURCE_BRANCH\`.

          ### Changes
          - Sets \`+x\` (executable) permission on \`.sh\` files with mode \`100644\`
          - Uses \`git update-index --chmod=+x\` to update git index

          ### Files Modified
          \`\`\`
          $sh_files
          \`\`\`

          ---
          ðŸ¤– Auto-generated by [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})")

            echo "âœ“ Created PR: $PR_URL"

            # Extract PR number from URL
            PR_NUMBER=$(echo "$PR_URL" | grep -oP '\d+$')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi

      - name: Set PR labels and auto-merge
        id: configure_pr
        if: steps.chmod.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.create_pr.outputs.pr_number }}"

          # Add labels (create them if they don't exist)
          gh label create "automated" --description "Auto-generated by GitHub Actions" --color "0e8a16" --force || true
          gh label create "chore" --description "Maintenance tasks" --color "fef2c0" --force || true

          gh pr edit "$PR_NUMBER" --add-label "automated,chore"
          echo "âœ“ Added labels: automated, chore"

          # Enable auto-merge (squash merge by default)
          gh pr merge "$PR_NUMBER" --auto --squash
          echo "âœ“ Enabled auto-merge (squash)"

          echo "Note: PR will auto-merge once all required checks pass and approvals are received"
