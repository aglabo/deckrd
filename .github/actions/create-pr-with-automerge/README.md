# Create PR with Auto-Merge Action

A reusable composite action that creates or updates Pull Requests with
labels and auto-merge enabled.

**ü§ñ Designed for automated Bot workflows** - This action automatically
enables auto-merge. Ensure your organization's policies permit
auto-merge for Bot-generated PRs before use.

## Features

- **Smart Branch Management**: Creates new PR branches or updates existing ones
- **Flexible Labeling**: Auto-creates labels if they don't exist and
  applies them to PRs
- **Auto-Merge Support**: Enables auto-merge with configurable merge
  methods (merge, squash, rebase)
- **Idempotent**: Safe to run multiple times - updates existing PRs
  instead of failing
- **Native GitHub CLI**: Uses `gh` CLI for maximum flexibility and reliability

## Usage

### Basic Example

```yaml
- name: Create Pull Request
  uses: ./.github/actions/create-pr-with-automerge
  with:
    branch-prefix: "auto-fix"
    source-branch: ${{ github.ref_name }}
    pr-title: "fix: Auto-fix issues"
    pr-body: "This PR automatically fixes detected issues."
    labels: "automated,fix"
    merge-method: "squash"
```

### Advanced Example

````yaml
- name: Create PR with custom settings
  id: create_pr
  uses: ./.github/actions/create-pr-with-automerge
  with:
    branch-prefix: "auto-chmod"
    source-branch: ${{ github.ref_name }}
    pr-title: "[Chmod] ci(scripts): Fix shell script permissions"
    pr-body: |
      ## Auto-generated PR: Shell Script Permission Fix

      This PR automatically fixes executable permissions...

      ### Files Modified
      ```
      ${{ steps.chmod.outputs.changed_files }}
      ```

      ü§ñ Auto-generated by GitHub Actions
    labels: "automated,chore"
    merge-method: "squash"
    github-token: ${{ secrets.GITHUB_TOKEN }}

- name: Use PR outputs
  run: |
    echo "PR Number: ${{ steps.create_pr.outputs.pr-number }}"
    echo "PR URL: ${{ steps.create_pr.outputs.pr-url }}"
    echo "Operation: ${{ steps.create_pr.outputs.pr-operation }}"
````

## Inputs

<!-- markdownlint-disable MD013 -->

| Input           | Description                      | Required | Default               |
| --------------- | -------------------------------- | -------- | --------------------- |
| `branch-prefix` | Prefix for PR branch             | Yes      | -                     |
| `source-branch` | Source branch name (base for PR) | Yes      | -                     |
| `pr-title`      | Pull request title               | Yes      | -                     |
| `pr-body`       | Pull request body/description    | Yes      | -                     |
| `labels`        | Comma-separated labels to add    | No       | `''` (empty)          |
| `merge-method`  | Auto-merge method (merge/squash) | No       | `squash`              |
| `github-token`  | GitHub token for operations      | No       | `${{ github.token }}` |

<!-- markdownlint-enable MD013 -->

## Outputs

| Output         | Description                                        |
| -------------- | -------------------------------------------------- |
| `pr-number`    | Created/updated PR number                          |
| `pr-url`       | Pull request URL                                   |
| `pr-operation` | Operation performed (`created`, `updated`, `none`) |

## Branch Naming

The action creates PR branches using the pattern: `{branch-prefix}/{source-branch}`

**Examples**:

- `source-branch: feat/new-feature` + `branch-prefix: auto-chmod`
  = `auto-chmod/feat/new-feature`
- `source-branch: main` + `branch-prefix: auto-fix` = `auto-fix/main`

## Label Management

Labels specified in the `labels` input are:

1. Created automatically if they don't exist (using `gh label create --force`)
2. Applied to the PR
3. Comma-separated (e.g., `"automated,chore,fix"`)

**Note**: Labels are created with default colors. To customize label
colors, create them manually in the repository settings first.

## Auto-Merge Behavior

The action enables auto-merge with the specified method:

- `squash` (default): Squash commits into one
- `merge`: Standard merge commit
- `rebase`: Rebase and merge

**Requirements**:

- Repository must have auto-merge enabled in settings
- Branch protection rules must be satisfied
- Required status checks must pass
- Required approvals must be received

The PR will automatically merge once all conditions are met.

**‚ö†Ô∏è Organization Policy Warning**:

This action is designed for **automated Bot workflows only**. Some
organizations have policies prohibiting auto-merge. Before using this
action:

- Verify your organization allows auto-merge for Bot PRs
- Check if specific merge methods (squash/merge/rebase) are restricted
- Ensure compliance with your team's code review policies
- Consider using `merge-method: "squash"` as the safest default

## Requirements

### Repository Settings

1. **Auto-merge enabled**: Settings ‚Üí General ‚Üí Allow auto-merge
2. **Branch protection** (recommended): Protect base branches with
   required checks

### Workflow Permissions

The workflow must have `contents: write` permission:

```yaml
permissions:
  contents: write
  pull-requests: write # Usually included in contents: write
```

### GitHub Token

The action uses `${{ github.token }}` by default, which has sufficient
permissions for most cases. For advanced scenarios (e.g., triggering
other workflows), use a Personal Access Token:

```yaml
github-token: ${{ secrets.PAT_TOKEN }}
```

## How It Works

1. **Create/Update Branch**: Checks if PR branch exists and either
   creates or updates it
2. **Commit Changes**: Commits staged changes with bot identity
3. **Push Branch**: Force pushes to handle updates
4. **Create/Update PR**: Creates new PR or detects existing one
5. **Apply Labels**: Creates labels if needed and applies them
6. **Enable Auto-Merge**: Configures auto-merge with specified method

## Limitations

- **Requires staged changes**: The action expects changes to be already
  staged (`git add`)
- **Force push**: Updates use force push, which overwrites PR branch
  history
- **Single PR per branch pair**: One PR from `{prefix}/{source}` to
  `{source}` at a time

## Troubleshooting

### "Nothing to commit"

Ensure changes are staged before calling this action:

```yaml
- name: Stage changes
  run: git add .

- name: Create PR
  uses: ./.github/actions/create-pr-with-automerge
  with:
# ... inputs
```

### Auto-merge not working

Check:

1. Repository has auto-merge enabled
2. Branch protection rules are satisfied
3. Required status checks are passing
4. Required approvals are received

### Labels not created

The action creates labels with `--force` flag. If this fails:

1. Check `github-token` has sufficient permissions
2. Verify repository settings allow label creation

## Related Documentation

- [GitHub CLI Manual](https://cli.github.com/manual/)
- [GitHub Auto-Merge Documentation](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/automatically-merging-a-pull-request)
- [Composite Actions Guide](https://docs.github.com/en/actions/creating-actions/creating-a-composite-action)

## License

MIT License - Copyright (c) 2025 atsushifx
